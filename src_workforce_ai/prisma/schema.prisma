// WorkForce AI - Prisma Schema
// Database: PostgreSQL
// ORM: Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified DateTime?
  image         String?
  password      String?   // For credentials auth
  role          UserRole  @default(USER)

  // NextAuth.js relations
  accounts      Account[]
  sessions      Session[]

  // App relations
  companies     CompanyMember[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// TRIAL SESSIONS (No signup required)
// ============================================================================

model TrialSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  email        String?  // Optional for conversion tracking
  ipAddress    String?
  userAgent    String?

  // Trial limitations
  workersCreated Int     @default(0)
  executionsRun  Int     @default(0)

  // Lifecycle
  expiresAt    DateTime
  convertedToUserId String? // If user signs up
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  workers      Worker[]
  executions   WorkerExecution[]

  @@index([sessionToken])
  @@index([expiresAt])
  @@map("trial_sessions")
}

// ============================================================================
// COMPANY STRUCTURE
// ============================================================================

model Company {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  website     String?

  // Subscription
  tier        SubscriptionTier @default(FREE_TRIAL)
  status      CompanyStatus    @default(ACTIVE)

  // Limits based on tier
  maxWorkers     Int @default(3)
  maxDepartments Int @default(1)
  maxExecutions  Int @default(100) // per month

  // Usage tracking
  currentWorkers    Int @default(0)
  currentDepartments Int @default(0)
  executionsThisMonth Int @default(0)

  // Lifecycle
  trialEndsAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime? // Soft delete

  // Relations
  members      CompanyMember[]
  departments  Department[]
  workers      Worker[]
  subscription Subscription?
  executions   WorkerExecution[]

  @@index([slug])
  @@index([status])
  @@map("companies")
}

enum SubscriptionTier {
  FREE_TRIAL    // 3 workers, 1 dept, 100 exec/mo
  STARTER       // 10 workers, 3 dept, 1K exec/mo - $29
  COMPANY_BLOCK // 50 workers, 10 dept, 10K exec/mo - $99
  CEO           // Unlimited workers/dept, 100K exec/mo - $299
  ENTERPRISE    // Custom
}

enum CompanyStatus {
  ACTIVE
  SUSPENDED
  TRIAL_EXPIRED
  DELETED
}

model CompanyMember {
  id        String      @id @default(cuid())
  companyId String
  userId    String
  role      MemberRole  @default(VIEWER)

  company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([companyId, userId])
  @@index([userId])
  @@map("company_members")
}

enum MemberRole {
  OWNER
  ADMIN
  MANAGER
  VIEWER
}

// ============================================================================
// DEPARTMENTS
// ============================================================================

model Department {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  color       String?  // For UI

  // Manager assignment (optional)
  managerId   String?

  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  workers     Worker[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@map("departments")
}

// ============================================================================
// WORKERS (AI Agents)
// ============================================================================

model Worker {
  id           String       @id @default(cuid())
  companyId    String?      // Null for trial sessions
  departmentId String?
  trialSessionId String?    // For trial users

  name         String
  description  String?
  type         WorkerType

  // Prompt-based creation
  originalPrompt String    @db.Text
  enhancedPrompt String?   @db.Text // From n8n enhance-prompt workflow

  // n8n workflow reference
  workflowId     String?    // n8n workflow ID
  workflowActive Boolean    @default(false)

  // Configuration
  config         Json?      // Worker-specific config
  credentials    Json?      // Encrypted credentials for integrations

  // Status
  status         WorkerStatus @default(DRAFT)
  deployedAt     DateTime?
  lastExecutedAt DateTime?

  // Stats
  totalExecutions     Int @default(0)
  successfulExecutions Int @default(0)
  failedExecutions     Int @default(0)

  // Relations
  company      Company?          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department   Department?       @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  trialSession TrialSession?     @relation(fields: [trialSessionId], references: [id], onDelete: Cascade)
  executions   WorkerExecution[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([companyId])
  @@index([departmentId])
  @@index([trialSessionId])
  @@index([status])
  @@map("workers")
}

enum WorkerType {
  SALES
  SUPPORT
  MARKETING
  DEVELOPMENT
  OPERATIONS
  CUSTOM
}

enum WorkerStatus {
  DRAFT       // Created but not deployed
  DEPLOYING   // Deploying to n8n
  ACTIVE      // Deployed and active
  PAUSED      // Temporarily disabled
  ERROR       // Deployment or runtime error
  ARCHIVED    // Soft deleted
}

// ============================================================================
// WORKER EXECUTIONS
// ============================================================================

model WorkerExecution {
  id              String   @id @default(cuid())
  workerId        String
  companyId       String?
  trialSessionId  String?

  // n8n execution details
  n8nExecutionId  String?  @unique

  // Input/Output
  input           Json?
  output          Json?
  error           Json?

  // Execution metadata
  status          ExecutionStatus
  startedAt       DateTime
  completedAt     DateTime?
  duration        Int?     // milliseconds

  // Cost tracking
  tokensUsed      Int?
  costUsd         Float?

  worker          Worker         @relation(fields: [workerId], references: [id], onDelete: Cascade)
  company         Company?       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  trialSession    TrialSession?  @relation(fields: [trialSessionId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([workerId])
  @@index([companyId])
  @@index([trialSessionId])
  @@index([status])
  @@index([startedAt])
  @@map("worker_executions")
}

enum ExecutionStatus {
  RUNNING
  SUCCESS
  FAILED
  TIMEOUT
  CANCELLED
}

// ============================================================================
// WORKFLOW TEMPLATES
// ============================================================================

model WorkflowTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    WorkerType

  // Template data
  n8nWorkflowJson Json   // n8n workflow definition
  configSchema    Json?  // JSON schema for config

  // Metadata
  icon        String?
  tags        String[]
  featured    Boolean  @default(false)
  usageCount  Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([featured])
  @@map("workflow_templates")
}

// ============================================================================
// BILLING & SUBSCRIPTIONS
// ============================================================================

model Subscription {
  id              String           @id @default(cuid())
  companyId       String           @unique

  // Stripe details
  stripeCustomerId       String?  @unique
  stripeSubscriptionId   String?  @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // Subscription details
  tier            SubscriptionTier
  status          SubscriptionStatus @default(ACTIVE)

  // Billing
  billingCycle    BillingCycle     @default(MONTHLY)
  amount          Float
  currency        String           @default("USD")

  // Lifecycle
  trialEndsAt     DateTime?
  cancelAt        DateTime?
  canceledAt      DateTime?

  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoices        Invoice[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  UNPAID
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

model Invoice {
  id             String   @id @default(cuid())
  subscriptionId String

  // Stripe details
  stripeInvoiceId String? @unique

  // Invoice details
  amount         Float
  currency       String   @default("USD")
  status         InvoiceStatus

  // Dates
  periodStart    DateTime
  periodEnd      DateTime
  dueDate        DateTime?
  paidAt         DateTime?

  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  companyId  String?

  action     String   // e.g., "worker.create", "company.update"
  entity     String   // e.g., "Worker", "Company"
  entityId   String

  changes    Json?    // Before/after data
  metadata   Json?    // Additional context

  ipAddress  String?
  userAgent  String?

  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([companyId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
